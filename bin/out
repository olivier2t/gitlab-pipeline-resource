#!/bin/bash

set -e

exec 5>&1 # make stdout available as fd 5 for the result
exec 1>&2 # redirect all output to stderr for logging

main() {
  echo "--[OUT]-------------------------"
  sourcesDirectory $1
  putResource
  waitForCompletion
  emitResult
}

sourcesDirectory() {
  sources_dir=$1
  echo "--> sources directory is: $sources_dir"
  cd $sources_dir
}

putResource() {
  echo "--> Triggering GitLab pipeline ..."

  variables_entries=$(echo "${source_variables}" | jq -r '. | to_entries')
  cmd="curl -s --request POST --form token=${source_trigger_token} --form ref=${source_ref}"
  for row in $(echo "${variables_entries}" | jq -r '.[] | @base64'); do
      _jq() {
      echo ${row} | base64 -d | jq -r ${1}
      }
    cmd="${cmd} --form 'variables[$(_jq '.key')]=$(_jq '.value')'"
  done
  cmd="${cmd} ${source_base_url}/api/v4/projects/${source_project_id}/trigger/pipeline"
  
  response_body=$(mktemp /tmp/response_body.XXXXXX)
  eval "$cmd" > $response_body || exit $1
  cat ${response_body} | jq -r '.'

  pipeline_id=$(cat $response_body | jq -r ".id")
  pipeline_status=$(cat $response_body | jq -r ".status")
  pipeline_web_url=$(cat $response_body | jq -r ".web_url")
  pipeline_created_by=$(cat $response_body | jq -r ".user.name")
  pipeline_created_at=$(cat $response_body | jq -r ".created_at")
}

waitForCompletion() {
  echo "--> wait for GitLab pipeline ID ${pipeline_id} to complete"
  duration=0
  until [ "${pipeline_status}" = "success" -o "${pipeline_status}" = "failed" -o "${pipeline_status}" = "canceled" ];
  do
    sleep 10
    duration="$((duration+10))"
    pipeline_status=$(curl -s --header "PRIVATE-TOKEN: ${source_access_token}" \
      "${source_base_url}/api/v4/projects/${source_project_id}/pipelines/${pipeline_id}" | jq -r ".status") || exit $1
    echo "Pipeline current status: ${pipeline_status} (${duration}s)"
  done
  if [ "${pipeline_status}" = "success" ]; then
    echo "Pipeline completed successfully"
  else
    echo "Pipeline did not complete (status: ${pipeline_status})"
    echo "--> GitLab pipeline URL: ${pipeline_web_url}"
    echo "Aborting job..."
    exit 1;
  fi
}

emitResult() {
  jq  --arg pipeline_id "$pipeline_id" \
      --arg pipeline_status "$pipeline_status" \
      --arg pipeline_web_url "$pipeline_web_url" \
      --arg pipeline_created_by "$pipeline_created_by" \
      --arg pipeline_created_at "$pipeline_created_at" \
      -n '{
    "version": {
      "id": $pipeline_id
    },
    "metadata": [
      { "name": "status", "value": $pipeline_status },
      { "name": "web_url", "value": $pipeline_web_url },
      { "name": "created_by", "value": $pipeline_created_by },
      { "name": "created_at", "value": $pipeline_created_at }
    ]
  }' >&5
}

if [ "${BASH_SOURCE[0]}" == "${0}" ]; then
  source $(dirname $0)/common
  main "$@"
fi
